#!/bin/bash
#TODO use ansible facts to get the env
env=`grep -Eo '([A-Za-z]+)' /etc/hostname`
repo="https://github.com/bob5ec/running-docker-stack.git"
target=".running_docker_stack"

cd
CHANGED_REPO=0
if [ ! -d "$target" ]; then
	git clone -b $env $repo $target
	cd $target
	CHANGED_REPO=1
else
	cd $target
	git pull |grep "Already up-to-date"
	CHANGED_REPO=$?
fi

# first line is chaty docker
RUNNING_IMAGES=`docker ps|wc -l`

git-crypt unlock || exit 1
for compose in *.yml; do
	#use every yml as compose file and project name
	BEFORE=`docker images`
	docker-compose -f $compose -p `basename $compose .yml` pull
	AFTER=`docker images`
	if [ "$RUNNING_IMAGES" == "1" "$BEFORE" != "$AFTER" -o "$CHANGED_REPO" == "1" ]; then
		docker-compose -f $compose -p `basename $compose .yml` down
		docker-compose -f $compose -p `basename $compose .yml` up -d
	fi
done
#TODO improve secrets security, e.g. copy them into the container
#git-crypt lock
